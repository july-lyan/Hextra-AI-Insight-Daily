name: Sync to Notion

on:
  # åœ¨å†…å®¹æ›´æ–°å·¥ä½œæµå®Œæˆåè§¦å‘
  workflow_run:
    workflows: ["Update Content from Daily Notes"]
    types:
      - completed
  
  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      date:
        description: 'è¦åŒæ­¥çš„æ—¥æœŸ (æ ¼å¼: YYYY-MM-DDï¼Œç•™ç©ºåˆ™åŒæ­¥æœ€æ–°)'
        required: false
        default: ''
  
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤© UTC æ—¶é—´ 1:00 (åŒ—äº¬æ—¶é—´æ—©ä¸Š 9:00)
  schedule:
    - cron: '0 1 * * *'

jobs:
  sync-to-notion:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install @notionhq/client

      - name: Find latest content file
        id: find_content
        run: |
          if [ -z "${{ github.event.inputs.date }}" ]; then
            # æŸ¥æ‰¾æœ€æ–°çš„å†…å®¹æ–‡ä»¶
            LATEST_FILE=$(find content/cn -name "*.md" -type f -not -name "_index.md" -not -name "about.md" -not -name "contact.md" | sort -r | head -1)
          else
            # ä½¿ç”¨æŒ‡å®šçš„æ—¥æœŸ
            DATE="${{ github.event.inputs.date }}"
            LATEST_FILE=$(find content/cn -name "${DATE}.md" -type f | head -1)
          fi
          
          if [ -z "$LATEST_FILE" ]; then
            echo "æœªæ‰¾åˆ°å†…å®¹æ–‡ä»¶"
            exit 1
          fi
          
          echo "file_path=$LATEST_FILE" >> $GITHUB_OUTPUT
          echo "æ‰¾åˆ°æ–‡ä»¶: $LATEST_FILE"

      - name: Extract content metadata
        id: extract_meta
        run: |
          FILE="${{ steps.find_content.outputs.file_path }}"
          
          # æå– frontmatter
          TITLE=$(grep -m 1 "^title:" "$FILE" | sed 's/^title: *"\(.*\)"/\1/' | sed "s/^title: *'\(.*\)'/\1/" | sed 's/^title: *\(.*\)/\1/')
          DATE=$(grep -m 1 "^date:" "$FILE" | sed 's/^date: *\(.*\)/\1/')
          DESCRIPTION=$(grep -m 1 "^description:" "$FILE" | sed 's/^description: *"\(.*\)"/\1/' | sed "s/^description: *'\(.*\)'/\1/" | sed 's/^description: *\(.*\)/\1/')
          
          # æå–æ­£æ–‡å†…å®¹ï¼ˆå»é™¤ frontmatterï¼‰
          CONTENT=$(awk '/^---$/{if(++count==2)next} count>=2' "$FILE")
          
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Sync to Notion
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          node << 'EOF'
          const { Client } = require('@notionhq/client');
          
          const notion = new Client({
            auth: process.env.NOTION_TOKEN,
          });
          
          const databaseId = process.env.NOTION_DATABASE_ID;
          
          const title = `${{ steps.extract_meta.outputs.title }}`;
          const date = `${{ steps.extract_meta.outputs.date }}`;
          const description = `${{ steps.extract_meta.outputs.description }}`;
          const content = `${{ steps.extract_meta.outputs.content }}`;
          
          // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ—¥æœŸçš„é¡µé¢
          const existingPages = await notion.databases.query({
            database_id: databaseId,
            filter: {
              property: 'Date',
              date: {
                equals: date,
              },
            },
          });
          
          if (existingPages.results.length > 0) {
            console.log(`å·²å­˜åœ¨æ—¥æœŸä¸º ${date} çš„é¡µé¢ï¼Œæ›´æ–°ä¸­...`);
            const pageId = existingPages.results[0].id;
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            await notion.pages.update({
              page_id: pageId,
              properties: {
                'Title': {
                  title: [
                    {
                      text: {
                        content: title,
                      },
                    },
                  ],
                },
                'Description': {
                  rich_text: [
                    {
                      text: {
                        content: description || '',
                      },
                    },
                  ],
                },
              },
            });
            
            // æ¸…ç©ºç°æœ‰å†…å®¹å¹¶æ·»åŠ æ–°å†…å®¹
            const blocks = await notion.blocks.children.list({
              block_id: pageId,
            });
            
            for (const block of blocks.results) {
              await notion.blocks.delete({
                block_id: block.id,
              });
            }
            
            // æ·»åŠ æ–°å†…å®¹ï¼ˆå°† Markdown è½¬æ¢ä¸º Notion blocksï¼‰
            const contentBlocks = convertMarkdownToBlocks(content);
            await notion.blocks.children.append({
              block_id: pageId,
              children: contentBlocks,
            });
            
            console.log('é¡µé¢æ›´æ–°æˆåŠŸ');
          } else {
            console.log(`åˆ›å»ºæ–°é¡µé¢: ${title}`);
            
            // åˆ›å»ºæ–°é¡µé¢
            const response = await notion.pages.create({
              parent: {
                database_id: databaseId,
              },
              properties: {
                'Title': {
                  title: [
                    {
                      text: {
                        content: title,
                      },
                    },
                  ],
                },
                'Date': {
                  date: {
                    start: date,
                  },
                },
                'Description': {
                  rich_text: [
                    {
                      text: {
                        content: description || '',
                      },
                    },
                  ],
                },
              },
            });
            
            // æ·»åŠ å†…å®¹
            const contentBlocks = convertMarkdownToBlocks(content);
            await notion.blocks.children.append({
              block_id: response.id,
              children: contentBlocks,
            });
            
            console.log('é¡µé¢åˆ›å»ºæˆåŠŸ');
          }
          
          // ç®€å•çš„ Markdown è½¬ Notion blocks å‡½æ•°
          function convertMarkdownToBlocks(markdown) {
            const blocks = [];
            const lines = markdown.split('\n');
            
            for (const line of lines) {
              if (!line.trim()) {
                continue;
              }
              
              // æ ‡é¢˜
              if (line.startsWith('# ')) {
                blocks.push({
                  object: 'block',
                  type: 'heading_1',
                  heading_1: {
                    rich_text: [{ type: 'text', text: { content: line.substring(2).trim() } }],
                  },
                });
              } else if (line.startsWith('## ')) {
                blocks.push({
                  object: 'block',
                  type: 'heading_2',
                  heading_2: {
                    rich_text: [{ type: 'text', text: { content: line.substring(3).trim() } }],
                  },
                });
              } else if (line.startsWith('### ')) {
                blocks.push({
                  object: 'block',
                  type: 'heading_3',
                  heading_3: {
                    rich_text: [{ type: 'text', text: { content: line.substring(4).trim() } }],
                  },
                });
              } else if (line.startsWith('- ') || line.startsWith('* ')) {
                // åˆ—è¡¨é¡¹
                blocks.push({
                  object: 'block',
                  type: 'bulleted_list_item',
                  bulleted_list_item: {
                    rich_text: [{ type: 'text', text: { content: line.substring(2).trim() } }],
                  },
                });
              } else if (line.match(/^\d+\. /)) {
                // æœ‰åºåˆ—è¡¨
                blocks.push({
                  object: 'block',
                  type: 'numbered_list_item',
                  numbered_list_item: {
                    rich_text: [{ type: 'text', text: { content: line.replace(/^\d+\. /, '').trim() } }],
                  },
                });
              } else {
                // æ™®é€šæ®µè½
                blocks.push({
                  object: 'block',
                  type: 'paragraph',
                  paragraph: {
                    rich_text: [{ type: 'text', text: { content: line.trim() } }],
                  },
                });
              }
            }
            
            return blocks;
          }
          EOF

      - name: Summary
        run: |
          echo "âœ… å†…å®¹å·²åŒæ­¥åˆ° Notion"
          echo "ğŸ“„ æ–‡ä»¶: ${{ steps.find_content.outputs.file_path }}"
          echo "ğŸ“… æ—¥æœŸ: ${{ steps.extract_meta.outputs.date }}"
          echo "ğŸ“ æ ‡é¢˜: ${{ steps.extract_meta.outputs.title }}"
